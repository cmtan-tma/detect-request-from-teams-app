<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <!-- Microsoft Teams JavaScript API (via CDN) -->
  <script src="https://statics.teams.microsoft.com/sdk/v1.5.2/js/MicrosoftTeams.min.js"
    crossorigin="anonymous"></script>
  <title>Send Cookie From Teams App</title>
</head>

<body>
  <main>
    <h3>Where is this?</h3>
    <div id="in-teams">
      In Teams App: No
    </div>
    <h3>Cookie received from Server: </h3>
    <div id="cookie-response">
      There is no cookie
    </div>
    <div id="session-storage-response">
      There is no session-storage
    </div>
  </main>
  <script>

    microsoftTeams.initialize()

    const inTeams = document.getElementById("in-teams")
    const cookieResponse = document.getElementById("cookie-response")
    const sessionStorageResponse = document.getElementById('session-storage-response')
    const IN_TEAMS_SESSION_STORAGE_KEY = 'in_teams'

    const sendCookie = async () => {
      const bodyData = {
        fromSessionStorage: 'in_teams=FALSE'
      }

      if (sessionStorage.getItem(IN_TEAMS_SESSION_STORAGE_KEY)) {
        bodyData.fromSessionStorage = sessionStorage.getItem(IN_TEAMS_SESSION_STORAGE_KEY) // 'TRUE'
      }

      const res = await fetch('/api/teams', {
        method: 'POST',
        credentials: "include",
        body: JSON.stringify(bodyData)
      })

      if (res.ok) {
        const result = await res.json();

        if (result.fromCookie) {
          cookieResponse.innerHTML = result.fromCookie
        }

        if (result.fromSessionStorage) {
          sessionStorageResponse.innerHTML = result.fromSessionStorage
        }
      }
    }

    const setCookie = () => {
      // Get Context
      microsoftTeams.getContext((context) => {
        inTeams.innerHTML = "In Teams App: Yes"

        // Set cookie
        document.cookie = "in_teams=TRUE;SameSite=None;Secure"

        // Set session storage
        sessionStorage.setItem(IN_TEAMS_SESSION_STORAGE_KEY, 'TRUE');

        sendCookie();
      })
    }

    setCookie();

  </script>
</body>

</html>